# Changelog — canonical cache для Firebase Storage refs

Дата: 2025-12-17

## Контекст / проблема
У DevTools Network спостерігався “шторм” запитів до Firebase Storage API `.../v0/b/<bucket>/o?name=artist%2F...png` (часто з `CORS + 404`). Ініціатором виступав Storage SDK (`connection.ts`), тобто джерело — повторні виклики `getDownloadURL()` для одного й того ж об’єкта.

Причина: кешування/дедуплікація працювали по рядку `candidate` (наприклад `gs://...`), але фактично один і той самий файл міг приходити в **різних форматах** (gs://, bare path, /o/…, /o?name=…), через що ключі кешу відрізнялись і SDK викликався багаторазово.

## Що було
- `missingStorageRefs` та `inFlightStorageUrls` ключувалися рядком `candidate`.
- Якщо одна й та сама сутність приходила в різних форматах, дедуп міг не спрацювати → повторні `getDownloadURL()` → повторні `o?name=` запити.

## Що стало
- Додано парсер `parseStorageRef()` та нормалізацію bucket/path.
- Кешування/негативне кешування/дедуп переведено на **канонічний ключ** `bucket/path`.
- Додано `resolvedStorageUrls` (позитивний кеш): якщо URL вже резолвився — повторні рендери не звертаються до SDK.

## Файли
- Зміни коду: public/index.html
- Новий тест-чекліст: tests/storage-canonical-ref-cache.md

## Очікуваний результат
- Повторні `.../o?name=...` (CORS/404) для одного й того ж `artist/...` мають припинитись у межах сесії навіть при різних форматах посилань у Firestore.

## Примітки
- Це не “лікує” реальну відсутність файлу/доступу; це прибирає повтори й зависання, роблячи деградацію керованою (перший фейл → подальше кешоване `null`).
